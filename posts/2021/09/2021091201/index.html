<!doctype html><html lang=zh-cn><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="ooorange "><meta name=description content="人在家中坐，祸从天上来。没想到nginx服务自己莫名其妙停掉了，考虑到之前自建的地基也是别人给搞的，可能不太牢靠，所以这次要自食其力。 先找教"><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://blog.notomorrow.club/posts/2021/09/2021091201/><title>自建V2Ray :: NoTomorrow Club
</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://blog.notomorrow.club/main.e198ea88f244271d71fc81129cb04b55239ab5062fbf7524cdb6893bb20811b0.css><link rel=apple-touch-icon sizes=180x180 href=https://blog.notomorrow.club/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://blog.notomorrow.club/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.notomorrow.club/favicon-16x16.png><link rel=manifest href=https://blog.notomorrow.club/site.webmanifest><link rel=mask-icon href=https://blog.notomorrow.club/safari-pinned-tab.svg color=#1b1c1d><link rel="shortcut icon" href=https://blog.notomorrow.club/favicon.ico><meta name=msapplication-TileColor content="#1b1c1d"><meta name=theme-color content="#1b1c1d"><meta itemprop=name content="自建V2Ray"><meta itemprop=description content="人在家中坐，祸从天上来。没想到nginx服务自己莫名其妙停掉了，考虑到之前自建的地基也是别人给搞的，可能不太牢靠，所以这次要自食其力。 先找教"><meta itemprop=datePublished content="2021-09-12T18:00:00+08:00"><meta itemprop=dateModified content="2021-09-20T21:07:38+08:00"><meta itemprop=wordCount content="1062"><meta itemprop=image content="https://blog.notomorrow.club/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.notomorrow.club/"><meta name=twitter:title content="自建V2Ray"><meta name=twitter:description content="人在家中坐，祸从天上来。没想到nginx服务自己莫名其妙停掉了，考虑到之前自建的地基也是别人给搞的，可能不太牢靠，所以这次要自食其力。 先找教"><meta property="og:url" content="https://blog.notomorrow.club/posts/2021/09/2021091201/"><meta property="og:site_name" content="NoTomorrow Club"><meta property="og:title" content="自建V2Ray"><meta property="og:description" content="人在家中坐，祸从天上来。没想到nginx服务自己莫名其妙停掉了，考虑到之前自建的地基也是别人给搞的，可能不太牢靠，所以这次要自食其力。 先找教"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-12T18:00:00+08:00"><meta property="article:modified_time" content="2021-09-20T21:07:38+08:00"><meta property="og:image" content="https://blog.notomorrow.club/"><meta property="article:published_time" content="2021-09-12 18:00:00 +0800 CST"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Anonymous+Pro:wght@700&family=EB+Garamond:ital,wght@0,400;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel=stylesheet></head><body><div class=container><header class=header><span class=header__inner><a href=https://blog.notomorrow.club/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ cd /</span>
<span class=breadcrumb><div class=breadcrumb><li><a class=breadcrumb href=https://blog.notomorrow.club/>NoTomorrow Club</a></li><li><a class=breadcrumb href=https://blog.notomorrow.club/posts/>Posts</a></li><li class=breadcrumb><a class=breadcrumb href=https://blog.notomorrow.club/posts/2021/09/2021091201/>自建V2Ray</a></li></div><style>.breadcrumb{list-style:none}.breadcrumb li{display:inline-block;font-display:auto}.breadcrumb li+li ::before{padding:0;content:"/"}.breadcrumb li a{text-decoration:none}</style></span><span class=logo__cursor style=animation-duration:1s></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://blog.notomorrow.club/posts/>Posts</a></li><li><a href=https://blog.notomorrow.club/tags/>Tags</a></li><li><a href=https://blog.notomorrow.club/categories/>Categoires</a></li><li><a href=https://blog.notomorrow.club/about/>About</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
3分钟</p></div><article><h1 class=post-title><a href=https://blog.notomorrow.club/posts/2021/09/2021091201/>自建V2Ray</a></h1><div class=post-content><p>人在家中坐，祸从天上来。没想到nginx服务自己莫名其妙停掉了，考虑到之前自建的地基也是别人给搞的，可能不太牢靠，所以这次要自食其力。</p><p>先找教程，过程波折。没有梯子打不开教程，打不开教程没办法学习自建。我在痛苦的死循环中挣扎了大概10多分钟，拿出了备用梯子，紧急上网，也不敢多用，万一又炸了呢，我站子还在上面呢。</p><h2 id=一基本搭建>一、基本搭建</h2><h3 id=1-配置ssl证书>1. 配置SSL证书</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y python36 <span style=color:#f92672>&amp;&amp;</span> pip3 install certbot <span style=color:#75715e>#安装Certbot</span>
</span></span><span style=display:flex><span>systemctl stop firewalld <span style=color:#f92672>&amp;&amp;</span> systemctl disable firewalld <span style=color:#75715e>#停止防火墙</span>
</span></span><span style=display:flex><span>certbot certonly --standalone --agree-tos -n -d example.com -m email <span style=color:#75715e>#申请SSL证书</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;0 0 1 */2 * service nginx stop; certbot renew; service nginx start;&#34;</span> | crontab <span style=color:#75715e>#证书自动更新</span>
</span></span></code></pre></div><h3 id=2-安装v2ray--nginx>2. 安装V2Ray & Nginx</h3><ol><li>一键安装 <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y curl <span style=color:#f92672>&amp;&amp;</span> yum install -y nginx <span style=color:#f92672>&amp;&amp;</span> bash &lt;<span style=color:#f92672>(</span>curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh<span style=color:#f92672>)</span>
</span></span></code></pre></div><p><strong>没有Nginx安装源</strong>
某些VPS商家提供的系统中，没有带nginx的安装源。因此在运行V2Ray和Nginx的一键安装命令时会出现以下错误：</p><blockquote><p>Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
*base: xxxxxx
*extras: xxxxxx
*updates: xxxxxx
No package nginx available.
Error: Nothing to do</p></blockquote><p>解决办法：手动添加安装源即可，根据你的系统版本，运行以下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rpm -ivh https://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm <span style=color:#75715e>#CentOS7：（这是大多数VPS的系统版本）</span>
</span></span><span style=display:flex><span>rpm -ivh https://nginx.org/packages/centos/8/x86_64/RPMS/nginx-1.18.0-1.el8.ngx.x86_64.rpm <span style=color:#75715e>#CentOS8</span>
</span></span></code></pre></div><ol start=2><li>关闭SELinux</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>setsebool -P httpd_can_network_connect <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> wetenforec <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h3 id=3-配置v2ray--nginx>3. 配置V2Ray & Nginx</h3><ol><li>V2Ray配置文件<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></li></ol><p><code>nano /usr/local/etc/v2ray/config.json</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;log&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;warning&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;routing&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;domainStrategy&#34;</span>: <span style=color:#e6db74>&#34;AsIs&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;rules&#34;</span>: [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;ip&#34;</span>: [
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;geoip:private&#34;</span>
</span></span><span style=display:flex><span>                ],
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;block&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;inbounds&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;listen&#34;</span>: <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>8964</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;vmess&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;settings&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;clients&#34;</span>: [
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span><span style=color:#960050;background-color:#1e0010>/*UUID</span>, <span style=color:#960050;background-color:#1e0010>www.uuidgenerator.net</span> <span style=color:#960050;background-color:#1e0010>*/</span>
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;ws&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;wsSettings&#34;</span>: {<span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/&#34;</span>},<span style=color:#960050;background-color:#1e0010>/*websocket路径随机字符串*/</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;security&#34;</span>: <span style=color:#e6db74>&#34;tls&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;outbounds&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;freedom&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;direct&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;blackhole&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;block&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>Nginx配置文件</li></ol><p><code>nano /etc/nginx/conf.d/default.conf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>server_name</span> <span style=color:#960050;background-color:#1e0010>;/*填写域名*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>listen</span> <span style=color:#960050;background-color:#1e0010>80</span> <span style=color:#960050;background-color:#1e0010>reuseport</span> <span style=color:#960050;background-color:#1e0010>fastopen=10;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>rewrite</span> <span style=color:#960050;background-color:#1e0010>^(.*)</span> <span style=color:#960050;background-color:#1e0010>https:</span><span style=color:#75715e>//$server_name$1 permanent;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#960050;background-color:#1e0010>if</span> <span style=color:#960050;background-color:#1e0010>($request_method</span>  <span style=color:#960050;background-color:#1e0010>!~</span> <span style=color:#960050;background-color:#1e0010>^(POST|GET)$)</span> <span style=color:#960050;background-color:#1e0010>{</span> <span style=color:#960050;background-color:#1e0010>return</span>  <span style=color:#960050;background-color:#1e0010>501;</span> }
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>autoindex</span> <span style=color:#960050;background-color:#1e0010>off;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>server_tokens</span> <span style=color:#960050;background-color:#1e0010>off;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_certificate</span> <span style=color:#960050;background-color:#1e0010>/etc/letsencrypt/live/example/fullchain.pem;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_certificate_key</span> <span style=color:#960050;background-color:#1e0010>/etc/letsencrypt/live/example/privkey.pem;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>location</span> <span style=color:#960050;background-color:#1e0010>/</span> <span style=color:#960050;background-color:#1e0010>/*v2ray配置文件中的websocket路径*/</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>proxy_pass</span> <span style=color:#960050;background-color:#1e0010>http:</span><span style=color:#75715e>//127.0.0.1:8964;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#960050;background-color:#1e0010>proxy_redirect</span> <span style=color:#960050;background-color:#1e0010>off;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>proxy_http_version</span> <span style=color:#960050;background-color:#1e0010>1.1;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>proxy_set_header</span> <span style=color:#960050;background-color:#1e0010>Upgrade</span> <span style=color:#960050;background-color:#1e0010>$http_upgrade;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>proxy_set_header</span> <span style=color:#960050;background-color:#1e0010>Connection</span> <span style=color:#f92672>&#34;upgrade&#34;</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>proxy_set_header</span> <span style=color:#960050;background-color:#1e0010>Host</span> <span style=color:#960050;background-color:#1e0010>$host;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>sendfile</span> <span style=color:#960050;background-color:#1e0010>on;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>tcp_nopush</span> <span style=color:#960050;background-color:#1e0010>on;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>tcp_nodelay</span> <span style=color:#960050;background-color:#1e0010>on;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>keepalive_requests</span> <span style=color:#ae81ff>10000</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>keepalive_timeout</span> <span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>h;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>proxy_buffering</span> <span style=color:#960050;background-color:#1e0010>off;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>listen</span> <span style=color:#ae81ff>443</span> <span style=color:#960050;background-color:#1e0010>ssl</span> <span style=color:#960050;background-color:#1e0010>reuseport</span> <span style=color:#960050;background-color:#1e0010>fastopen=</span><span style=color:#ae81ff>10</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>server_name</span> <span style=color:#960050;background-color:#1e0010>$server_name;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>charset</span> <span style=color:#960050;background-color:#1e0010>utf</span><span style=color:#ae81ff>-8</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>sendfile</span> <span style=color:#960050;background-color:#1e0010>on;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>tcp_nopush</span> <span style=color:#960050;background-color:#1e0010>on;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>tcp_nodelay</span> <span style=color:#960050;background-color:#1e0010>on;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>keepalive_requests</span> <span style=color:#ae81ff>10000</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>keepalive_timeout</span> <span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>h;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_protocols</span> <span style=color:#960050;background-color:#1e0010>TLSv</span><span style=color:#ae81ff>1.2</span> <span style=color:#960050;background-color:#1e0010>TLSv</span><span style=color:#ae81ff>1.3</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_ciphers</span> <span style=color:#960050;background-color:#1e0010>TLS</span><span style=color:#ae81ff>13</span><span style=color:#960050;background-color:#1e0010>-CHACHA</span><span style=color:#ae81ff>20</span><span style=color:#960050;background-color:#1e0010>-POLY</span><span style=color:#ae81ff>1305</span><span style=color:#960050;background-color:#1e0010>-SHA</span><span style=color:#ae81ff>256</span><span style=color:#960050;background-color:#1e0010>:TLS</span><span style=color:#ae81ff>13</span><span style=color:#960050;background-color:#1e0010>-AES</span><span style=color:#ae81ff>-128</span><span style=color:#960050;background-color:#1e0010>-GCM-SHA</span><span style=color:#ae81ff>256</span><span style=color:#960050;background-color:#1e0010>:TLS</span><span style=color:#ae81ff>13</span><span style=color:#960050;background-color:#1e0010>-AES</span><span style=color:#ae81ff>-256</span><span style=color:#960050;background-color:#1e0010>-GCM-SHA</span><span style=color:#ae81ff>384</span><span style=color:#960050;background-color:#1e0010>:ECDHE-ECDSA-AES</span><span style=color:#ae81ff>128</span><span style=color:#960050;background-color:#1e0010>-GCM-SHA</span><span style=color:#ae81ff>256</span><span style=color:#960050;background-color:#1e0010>:ECDHE-RSA-AES</span><span style=color:#ae81ff>128</span><span style=color:#960050;background-color:#1e0010>-GCM-SHA</span><span style=color:#ae81ff>256</span><span style=color:#960050;background-color:#1e0010>:ECDHE-ECDSA-AES</span><span style=color:#ae81ff>256</span><span style=color:#960050;background-color:#1e0010>-GCM-SHA</span><span style=color:#ae81ff>384</span><span style=color:#960050;background-color:#1e0010>:ECDHE-RSA-AES</span><span style=color:#ae81ff>256</span><span style=color:#960050;background-color:#1e0010>-GCM-SHA</span><span style=color:#ae81ff>384</span><span style=color:#960050;background-color:#1e0010>:ECDHE-ECDSA-CHACHA</span><span style=color:#ae81ff>20</span><span style=color:#960050;background-color:#1e0010>-POLY</span><span style=color:#ae81ff>1305</span><span style=color:#960050;background-color:#1e0010>:ECDHE-RSA-CHACHA</span><span style=color:#ae81ff>20</span><span style=color:#960050;background-color:#1e0010>-POLY</span><span style=color:#ae81ff>1305</span><span style=color:#960050;background-color:#1e0010>:DHE-RSA-AES</span><span style=color:#ae81ff>128</span><span style=color:#960050;background-color:#1e0010>-GCM-SHA</span><span style=color:#ae81ff>256</span><span style=color:#960050;background-color:#1e0010>:DHE-RSA-AES</span><span style=color:#ae81ff>256</span><span style=color:#960050;background-color:#1e0010>-GCM-SHA</span><span style=color:#ae81ff>384</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_ecdh_curve</span> <span style=color:#960050;background-color:#1e0010>secp</span><span style=color:#ae81ff>384</span><span style=color:#960050;background-color:#1e0010>r</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_prefer_server_ciphers</span> <span style=color:#960050;background-color:#1e0010>off;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_session_cache</span> <span style=color:#960050;background-color:#1e0010>shared:SSL:</span><span style=color:#ae81ff>60</span><span style=color:#960050;background-color:#1e0010>m;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_session_timeout</span> <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>d;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_session_tickets</span> <span style=color:#960050;background-color:#1e0010>off;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_stapling</span> <span style=color:#960050;background-color:#1e0010>on;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_stapling_verify</span> <span style=color:#960050;background-color:#1e0010>on;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>resolver</span> <span style=color:#ae81ff>8.8</span><span style=color:#960050;background-color:#1e0010>.</span><span style=color:#ae81ff>8.8</span> <span style=color:#ae81ff>8.8</span><span style=color:#960050;background-color:#1e0010>.</span><span style=color:#ae81ff>4.4</span> <span style=color:#960050;background-color:#1e0010>valid=</span><span style=color:#ae81ff>300</span><span style=color:#960050;background-color:#1e0010>s;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>resolver_timeout</span> <span style=color:#ae81ff>10</span><span style=color:#960050;background-color:#1e0010>s;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>if</span> <span style=color:#960050;background-color:#1e0010>($request_method</span>  <span style=color:#960050;background-color:#1e0010>!~</span> <span style=color:#960050;background-color:#1e0010>^(POST|GET)$)</span> { <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#960050;background-color:#1e0010>501;</span> }
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>add_header</span> <span style=color:#960050;background-color:#1e0010>X-Frame-Options</span> <span style=color:#960050;background-color:#1e0010>DENY;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>add_header</span> <span style=color:#960050;background-color:#1e0010>X-XSS-Protection</span> <span style=color:#e6db74>&#34;1; mode=block&#34;</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>add_header</span> <span style=color:#960050;background-color:#1e0010>X-Content-Type-Options</span> <span style=color:#960050;background-color:#1e0010>nosniff;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>add_header</span> <span style=color:#960050;background-color:#1e0010>Strict-Transport-Security</span> <span style=color:#960050;background-color:#1e0010>max-age=</span><span style=color:#ae81ff>31536000</span> <span style=color:#960050;background-color:#1e0010>always;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>autoindex</span> <span style=color:#960050;background-color:#1e0010>off;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>server_tokens</span> <span style=color:#960050;background-color:#1e0010>off;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>access_log</span> <span style=color:#960050;background-color:#1e0010>/var/log/nginx/nginx_access.log;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>error_log</span> <span style=color:#960050;background-color:#1e0010>/var/log/nginx/nginx_error.log;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>index</span> <span style=color:#960050;background-color:#1e0010>index.html</span> <span style=color:#960050;background-color:#1e0010>index.htm</span> <span style=color:#960050;background-color:#1e0010>index.php;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>root</span> <span style=color:#960050;background-color:#1e0010>/usr/share/nginx/html;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>location</span> <span style=color:#960050;background-color:#1e0010>~</span> <span style=color:#960050;background-color:#1e0010>.*\.(js|jpg|JPG|jpeg|JPEG|css|bmp|gif|GIF|png)$</span> { <span style=color:#960050;background-color:#1e0010>access_log</span> <span style=color:#960050;background-color:#1e0010>off;</span> }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><h3 id=4-验证配置3>4. 验证配置<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/local/bin/v2ray -test -config<span style=color:#f92672>=</span>/usr/local/etc/v2ray/config.json
</span></span><span style=display:flex><span>nginx -t
</span></span></code></pre></div><h3 id=5-启动服务>5. 启动服务</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>service v2ray start
</span></span><span style=display:flex><span>service nginx start
</span></span></code></pre></div><h2 id=二进一步强化>二、进一步强化</h2><h3 id=1-加固服务器>1. 加固服务器</h3><p>防火墙</p><h3 id=2-配置cdn>2. 配置CDN</h3><p>cloudflare开启代理</p><h3 id=3-使用bbr加速>3. 使用BBR加速</h3><h3 id=4-自行编译nginx>4. 自行编译Nginx</h3><h2 id=成果>成果</h2><p><strong>结果我又失败了</strong></p><ol><li><p>伪装路径没有正确显示<code>bad gateway</code></p></li><li><p>v2ray显示握手失败</p></li></ol><blockquote><p>[Warning] failed to handler mux client connection > v2ray.com/core/proxy/vmess/outbound: failed to find an available destination > v2ray.com/core/common/retry: [v2ray.com/core/transport/internet/websocket: failed to dial WebSocket > v2ray.com/core/transport/internet/websocket: failed to dial to (wss://<code>ip:port/path</code>): > dial tcp <code>ip:port</code>: connectex: No connection could be made because the target machine actively refused it.] > v2ray.com/core/common/retry: all retry attempts failed</p></blockquote><hr><p><em>参考</em></p><p><a href=https://pincong.rocks/article/id-15493>V2Ray翻墙完全教程(WS+TLS+Web)</a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>更新v2ray一键安装地址&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>更新v2ray配置文件存放地址&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>更具最新v2ray目录结构，更新测试命令&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
1062字</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2021-09-12 18:00
(最后修改: 2021-09-20 21:07)</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg>
<a href=https://github.com/ooorange777/hugo-blog/commit/4ca4789f3911557adcd330a2f86aa2742dd04ed0 target=_blank rel=noopener>4ca4789</a>
调整tag @ 2021-09-20</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://blog.notomorrow.club/posts/2021/10/2021102101/><span class=button__icon>←</span>
<span class=button__text>加入联邦宇宙一周年</span>
</a></span><span class="button next"><a href=https://blog.notomorrow.club/posts/2021/09/2021090701/><span class=button__text>Free Guy</span>
<span class=button__icon>→</span></a></span></div></div><div id=utterances></div><script id=utterance src=https://utteranc.es/client.js repo=ooorange777/ooorange777.github.io issue-term=title theme=github-light label=comment crossorigin=anonymous async></script></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021–2024</span>
<span><a href=https://blog.notomorrow.club/>NoTomorrow Club</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span></div></div><div class=footer__inner><div class=footer__content><span>Made with &#10084; by ooorange</span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a> | Theme is <a href=https://github.com/rhazdon/hugo-theme-hello-friend-ng>hello-friend-ng</a></span></div></div></footer></div><script type=text/javascript src=https://blog.notomorrow.club/bundle.min.3c4ecebaaa5f5db3d63a045a18c4867d20148afb661bf2856cb5e4e04bebeb6bc1337b379738ef27123bbd47b4cd04eecfde32e24b1b1161886fb43efbe90f44.js integrity="sha512-PE7OuqpfXbPWOgRaGMSGfSAUivtmG/KFbLXk4Evr62vBM3s3lzjvJxI7vUe0zQTuz94y4ksbEWGIb7Q+++kPRA=="></script></body></html>